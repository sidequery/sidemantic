# Source: MetricFlow official test fixtures - bookings_source.yaml
# https://github.com/dbt-labs/metricflow/blob/main/metricflow-semantics/metricflow_semantics/test_helpers/semantic_manifest_yamls/simple_manifest/semantic_models/bookings_source.yaml
# Tests: sum_boolean, median, percentile (with agg_params), partitioned dimensions,
#   multiple agg_time_dimensions, primary_entity shorthand, many aggregation types

semantic_models:
  - name: bookings_source
    description: bookings_source
    model: ref('fct_bookings')

    defaults:
      agg_time_dimension: ds

    measures:
      - name: bookings
        expr: "1"
        agg: sum
      - name: instant_bookings
        expr: is_instant
        agg: sum_boolean
      - name: booking_value
        agg: sum
      - name: max_booking_value
        agg: max
        expr: booking_value
      - name: min_booking_value
        agg: min
        expr: booking_value
      - name: bookers
        expr: guest_id
        agg: count_distinct
      - name: average_booking_value
        expr: booking_value
        agg: average
      - name: booking_payments
        expr: booking_value
        agg: sum
        agg_time_dimension: paid_at
      - name: referred_bookings
        expr: referrer_id
        agg: count
      - name: median_booking_value
        expr: booking_value
        agg: median
      - name: booking_value_p99
        expr: booking_value
        agg: percentile
        agg_params:
          percentile: 0.99
      - name: discrete_booking_value_p99
        expr: booking_value
        agg: percentile
        agg_params:
          percentile: 0.99
          use_discrete_percentile: true
      - name: approximate_continuous_booking_value_p99
        expr: booking_value
        agg: percentile
        agg_params:
          percentile: 0.99
          use_approximate_percentile: true
      - name: approximate_discrete_booking_value_p99
        expr: booking_value
        agg: percentile
        agg_params:
          percentile: 0.99
          use_discrete_percentile: true
          use_approximate_percentile: true

    dimensions:
      - name: is_instant
        type: categorical
      - name: ds
        type: time
        type_params:
          time_granularity: day
      - name: ds_partitioned
        type: time
        is_partition: true
        type_params:
          time_granularity: day
      - name: paid_at
        type: time
        type_params:
          time_granularity: day

    primary_entity: booking

    entities:
      - name: listing
        type: foreign
        expr: listing_id
      - name: guest
        type: foreign
        expr: guest_id
      - name: host
        type: foreign
        expr: host_id

metrics:
  - name: bookings
    description: bookings metric
    type: simple
    type_params:
      measure: bookings

  - name: instant_bookings
    description: instant bookings metric
    type: simple
    type_params:
      measure: instant_bookings

  - name: booking_fees_per_booker
    description: booking_fees divided by bookers
    type: derived
    type_params:
      expr: "booking_value * 0.05 / bookers"
      metrics:
        - name: booking_value
        - name: bookers

  - name: bookings_per_booker
    description: bookings divided by bookers
    type: ratio
    type_params:
      numerator:
        name: bookings
      denominator:
        name: bookers

  - name: instant_booking_value_ratio
    description: Instant booking value / booking value with filter and alias
    type: ratio
    type_params:
      numerator:
        name: booking_value
        filter: "{{ Dimension('booking__is_instant') }}"
        alias: booking_value_with_is_instant_constraint
      denominator:
        name: booking_value
