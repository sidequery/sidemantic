# Source: dbt-labs/metricflow (Apache 2.0)
# https://github.com/dbt-labs/metricflow/blob/main/metricflow-semantics/metricflow_semantics/test_helpers/semantic_manifest_yamls/simple_manifest/metrics.yaml
# Tests: 85+ metrics covering offset_window, offset_to_grain, nested derived, fill_nulls_with,
#   conversion with constant_properties, metric-level time_granularity, metric filters referencing
#   other metrics, percentile flavors, median, sum_boolean, period_agg, join_to_timespine,
#   alias reuse across derived metrics, cumulative with period_agg

semantic_models:
  - name: bookings_source
    description: bookings_source
    model: ref('fct_bookings')
    defaults:
      agg_time_dimension: ds
    measures:
      - name: bookings
        expr: "1"
        agg: sum
      - name: instant_bookings
        expr: is_instant
        agg: sum_boolean
      - name: booking_value
        agg: sum
      - name: max_booking_value
        agg: max
        expr: booking_value
      - name: min_booking_value
        agg: min
        expr: booking_value
      - name: bookers
        expr: guest_id
        agg: count_distinct
      - name: average_booking_value
        expr: booking_value
        agg: average
      - name: booking_payments
        expr: booking_value
        agg: sum
        agg_time_dimension: paid_at
      - name: referred_bookings
        expr: referrer_id
        agg: count
      - name: median_booking_value
        expr: booking_value
        agg: median
      - name: booking_value_p99
        expr: booking_value
        agg: percentile
        agg_params:
          percentile: 0.99
      - name: discrete_booking_value_p99
        expr: booking_value
        agg: percentile
        agg_params:
          percentile: 0.99
          use_discrete_percentile: true
      - name: approximate_continuous_booking_value_p99
        expr: booking_value
        agg: percentile
        agg_params:
          percentile: 0.99
          use_approximate_percentile: true
      - name: approximate_discrete_booking_value_p99
        expr: booking_value
        agg: percentile
        agg_params:
          percentile: 0.99
          use_discrete_percentile: true
          use_approximate_percentile: true
    dimensions:
      - name: is_instant
        type: categorical
      - name: ds
        type: time
        type_params:
          time_granularity: day
      - name: ds_partitioned
        type: time
        is_partition: true
        type_params:
          time_granularity: day
      - name: paid_at
        type: time
        type_params:
          time_granularity: day
    primary_entity: booking
    entities:
      - name: listing
        type: foreign
        expr: listing_id
      - name: guest
        type: foreign
        expr: guest_id
      - name: host
        type: foreign
        expr: host_id

metrics:
  # --- Simple metrics ---
  - name: bookings
    description: bookings metric
    type: simple
    type_params:
      measure: bookings

  - name: average_booking_value
    description: average booking value metric
    type: simple
    type_params:
      measure: average_booking_value

  - name: instant_bookings
    description: instant bookings
    type: simple
    type_params:
      measure: instant_bookings

  - name: booking_value
    description: booking value
    type: simple
    type_params:
      measure: booking_value

  - name: max_booking_value
    description: max booking value
    type: simple
    type_params:
      measure: max_booking_value

  - name: min_booking_value
    description: min booking value
    type: simple
    type_params:
      measure: min_booking_value

  - name: instant_booking_value
    description: booking value of instant bookings
    type: simple
    type_params:
      measure: booking_value
    filter: "{{ Dimension('booking__is_instant') }}"

  - name: average_instant_booking_value
    description: average booking value of instant bookings
    type: simple
    type_params:
      measure: average_booking_value
    filter: "{{ Dimension('booking__is_instant') }}"

  - name: booking_value_for_non_null_listing_id
    description: booking value filtered by non-null listing
    type: simple
    type_params:
      measure: booking_value
    filter: "{{ Entity('listing') }} IS NOT NULL"

  - name: bookers
    description: bookers
    type: simple
    type_params:
      measure: bookers

  - name: booking_payments
    description: Booking payments.
    type: simple
    type_params:
      measure: booking_payments

  - name: referred_bookings
    description: bookings made through a referral
    type: simple
    type_params:
      measure: referred_bookings

  - name: median_booking_value
    description: median booking value
    type: simple
    type_params:
      measure: median_booking_value

  - name: booking_value_p99
    description: p99 booking value
    type: simple
    type_params:
      measure: booking_value_p99

  - name: discrete_booking_value_p99
    description: discrete p99 booking value
    type: simple
    type_params:
      measure: discrete_booking_value_p99

  - name: approximate_continuous_booking_value_p99
    description: approximate continuous p99 booking value
    type: simple
    type_params:
      measure: approximate_continuous_booking_value_p99

  - name: approximate_discrete_booking_value_p99
    description: approximate discrete p99 booking value
    type: simple
    type_params:
      measure: approximate_discrete_booking_value_p99

  # --- Simple with fill_nulls_with / join_to_timespine ---
  - name: bookings_fill_nulls_with_0_without_time_spine
    description: Simple metric filling 0 without time spine.
    type: simple
    type_params:
      measure:
        name: bookings
        fill_nulls_with: 0

  - name: bookings_fill_nulls_with_0
    description: simple metric filling nulls with 0 and joining to time spine
    type: simple
    type_params:
      measure:
        name: bookings
        join_to_timespine: true
        fill_nulls_with: 0
    time_granularity: week

  - name: bookings_join_to_time_spine
    description: simple metric joining to time spine
    type: simple
    type_params:
      measure:
        name: bookings
        join_to_timespine: true

  - name: instant_bookings_with_measure_filter
    description: simple metric with timespine and measure filter
    type: simple
    type_params:
      measure:
        name: bookings
        join_to_timespine: true
        filter: "{{ Dimension('booking__is_instant') }}"
    filter: "{{ Entity('listing') }} IS NOT NULL"

  # --- Simple with metric-level time_granularity ---
  - name: largest_listing
    description: largest listing
    type: simple
    type_params:
      measure: largest_listing
    time_granularity: month

  # --- Simple with metric filter referencing another metric ---
  - name: active_listings
    description: Listings with at least 2 bookings
    type: simple
    type_params:
      measure: listings
    filter: "{{ Metric('bookings', ['listing']) }} > 2"

  # --- Cumulative metrics ---
  - name: trailing_2_months_revenue
    description: trailing_2_months_revenue with period_agg average
    type: cumulative
    type_params:
      measure: txn_revenue
      cumulative_type_params:
        window: 2 month
        period_agg: average

  - name: revenue_all_time
    description: revenue_all_time with period_agg last
    type: cumulative
    type_params:
      measure: txn_revenue
      cumulative_type_params:
        period_agg: last

  - name: every_two_days_bookers
    description: every_two_days_bookers
    type: cumulative
    type_params:
      measure: bookers
      window: 2 days

  - name: revenue_mtd
    description: revenue mtd (grain_to_date month)
    type: cumulative
    type_params:
      measure: txn_revenue
      cumulative_type_params:
        grain_to_date: month

  - name: bookings_all_time
    description: bookings cumulative all time
    type: cumulative
    type_params:
      measure: bookings

  - name: every_two_days_bookers_fill_nulls_with_0
    description: cumulative metric filling 0
    type: cumulative
    type_params:
      measure:
        name: bookers
        join_to_timespine: true
        fill_nulls_with: 0
      cumulative_type_params:
        window: 2 days

  - name: trailing_2_months_revenue_with_filter
    description: Cumulative metric with a filter
    type: cumulative
    filter: "{{ Dimension('user__home_state_latest') }} = 'CA'"
    type_params:
      measure: txn_revenue
      cumulative_type_params:
        window: 2 month

  - name: trailing_7_days_bookings
    description: trailing 7 days bookings
    type: cumulative
    type_params:
      measure: bookings
      cumulative_type_params:
        window: 7 days

  # --- Derived metrics ---
  - name: booking_fees
    description: Booking value multiplied by constant
    type: derived
    type_params:
      expr: "booking_value * 0.05"
      metrics:
        - name: booking_value

  - name: booking_fees_per_booker
    description: booking_fees divided by bookers
    type: derived
    type_params:
      expr: "booking_value * 0.05 / bookers"
      metrics:
        - name: booking_value
        - name: bookers

  - name: booking_fees_last_week_per_booker_this_week
    description: booking_fees with offset_window on one input
    type: derived
    type_params:
      expr: "booking_value * 0.05 / bookers"
      metrics:
        - name: booking_value
          offset_window: 1 week
        - name: bookers

  - name: views_times_booking_value
    description: cross-model derived metric
    type: derived
    type_params:
      expr: "booking_value * views"
      metrics:
        - name: booking_value
        - name: views

  - name: non_referred_bookings_pct
    description: percentage of bookings not through referral
    type: derived
    type_params:
      expr: (bookings - ref_bookings) * 1.0 / bookings
      metrics:
        - name: referred_bookings
          alias: ref_bookings
        - name: bookings

  - name: booking_value_sub_instant
    description: booking_value - instant_booking_value
    type: derived
    type_params:
      expr: booking_value - instant_booking_value
      metrics:
        - name: instant_booking_value
        - name: booking_value

  - name: booking_value_sub_instant_add_10
    description: nested derived (booking_value_sub_instant + 10)
    type: derived
    type_params:
      expr: booking_value_sub_instant + 10
      metrics:
        - name: booking_value_sub_instant

  - name: bookings_per_lux_listing_derived
    description: derived metric with filtered input
    type: derived
    type_params:
      expr: bookings * 1.0 / NULLIF(lux_listing, 0)
      metrics:
        - name: bookings
        - name: listings
          alias: lux_listing
          filter: "{{ Dimension('listing__is_lux_latest') }}"

  - name: instant_plus_non_referred_bookings_pct
    description: nested derived combining non_referred_bookings_pct + instant pct
    type: derived
    type_params:
      expr: non_referred + (instant * 1.0 / bookings)
      metrics:
        - name: non_referred_bookings_pct
          alias: non_referred
        - name: instant_bookings
          alias: instant
        - name: bookings

  - name: trailing_2_months_revenue_sub_10
    description: derived with cumulative input
    type: derived
    type_params:
      expr: t2mr - 10
      metrics:
        - name: trailing_2_months_revenue
          alias: t2mr

  - name: booking_value_per_view
    description: booking value per view (tests joins with nulls)
    type: derived
    type_params:
      expr: booking_value / NULLIF(views, 0)
      metrics:
        - name: booking_value
        - name: views

  - name: double_counted_delayed_bookings
    description: expr with single constrained and aliased measure
    type: derived
    type_params:
      expr: delayed_bookings * 2
      metrics:
        - name: bookings
          filter: "NOT {{ Dimension('booking__is_instant') }}"
          alias: delayed_bookings

  - name: lux_booking_value_rate_expr
    description: constrained measures with external dimension join
    type: derived
    type_params:
      expr: "average_booking_value * bookings / NULLIF(booking_value, 0)"
      metrics:
        - name: average_booking_value
          filter: "{{ Dimension('listing__is_lux_latest') }}"
        - name: bookings
          filter: "{{ Dimension('listing__is_lux_latest') }}"
        - name: booking_value

  - name: instant_lux_booking_value_rate
    description: filtered metric on nested derived
    type: derived
    type_params:
      expr: instant_lux_booking_value_rate
      metrics:
        - name: lux_booking_value_rate_expr
          filter: "{{ Dimension('booking__is_instant') }}"
          alias: instant_lux_booking_value_rate

  # --- Derived with offset_window ---
  - name: bookings_growth_2_weeks
    description: growth vs 2 weeks prior
    type: derived
    type_params:
      expr: bookings - bookings_2_weeks_ago
      metrics:
        - name: bookings
        - name: bookings
          offset_window: 14 days
          alias: bookings_2_weeks_ago

  - name: bookings_5_day_lag
    description: single input offset
    type: derived
    type_params:
      expr: bookings_5_days_ago
      metrics:
        - name: bookings
          offset_window: 5 days
          alias: bookings_5_days_ago

  - name: every_2_days_bookers_2_days_ago
    description: offset with cumulative input
    type: derived
    type_params:
      expr: every_2_days_bookers_2_days_ago
      metrics:
        - name: every_two_days_bookers
          offset_window: 2 days
          alias: every_2_days_bookers_2_days_ago

  - name: bookings_offset_once
    description: bookings offset once
    type: derived
    type_params:
      expr: 2 * bookings
      metrics:
        - name: bookings
          offset_window: 5 days

  - name: bookings_offset_twice
    description: bookings offset twice (nested)
    type: derived
    type_params:
      expr: 2 * bookings_offset_once
      metrics:
        - name: bookings_offset_once
          offset_window: 2 days

  - name: bookings_1_month_ago
    description: bookings 1 month ago
    type: derived
    type_params:
      expr: bookings
      metrics:
        - name: bookings
          offset_window: 1 month

  - name: bookings_mom
    description: bookings month over month
    type: derived
    type_params:
      expr: (bookings - bookings_1_month_ago) / NULLIF(bookings_1_month_ago, 0)
      metrics:
        - name: bookings
          offset_window: 1 month
          alias: bookings_1_month_ago
        - name: bookings

  - name: bookings_1_year_ago
    description: bookings 1 year ago
    type: derived
    type_params:
      expr: bookings
      metrics:
        - name: bookings
          offset_window: 1 year

  - name: bookings_yoy
    description: bookings year over year
    type: derived
    type_params:
      expr: (bookings - bookings_1_year_ago) / NULLIF(bookings_1_year_ago, 0)
      metrics:
        - name: bookings
          offset_window: 1 year
          alias: bookings_1_year_ago
        - name: bookings

  - name: trailing_7_days_bookings_offset_1_week
    description: cumulative input offset by 1 week
    type: derived
    type_params:
      expr: trailing_7_days_bookings_1_week_ago
      metrics:
        - name: trailing_7_days_bookings
          offset_window: 1 week
          alias: trailing_7_days_bookings_1_week_ago

  # --- Derived with offset_to_grain ---
  - name: bookings_all_time_at_start_of_month
    description: offset_to_grain month
    type: derived
    type_params:
      expr: bookings_all_time
      metrics:
        - name: bookings_all_time
          offset_to_grain: month

  - name: bookings_all_time_at_start_of_year
    description: offset_to_grain year
    type: derived
    type_params:
      expr: bookings_all_time
      metrics:
        - name: bookings_all_time
          offset_to_grain: year

  - name: bookings_growth_since_start_of_month
    description: growth since start of month
    type: derived
    type_params:
      expr: bookings - bookings_at_start_of_month
      metrics:
        - name: bookings
        - name: bookings
          offset_to_grain: month
          alias: bookings_at_start_of_month

  - name: bookings_at_start_of_month
    description: offset to grain single input
    type: derived
    type_params:
      expr: bookings_start_of_month
      metrics:
        - name: bookings
          offset_to_grain: month
          alias: bookings_start_of_month

  - name: booking_fees_since_start_of_month
    description: nested derived with offset
    type: derived
    type_params:
      expr: booking_fees - booking_fees_start_of_month
      metrics:
        - name: booking_fees
          offset_to_grain: month
          alias: booking_fees_start_of_month
        - name: booking_fees

  - name: bookings_since_start_of_month
    description: cumulative + offset_to_grain month
    type: derived
    type_params:
      expr: bookings_all_time - bookings_all_time_at_start_of_month
      metrics:
        - name: bookings_all_time
        - name: bookings_all_time
          offset_to_grain: month
          alias: bookings_all_time_at_start_of_month

  - name: bookings_since_start_of_year
    description: cumulative + offset_to_grain year
    type: derived
    type_params:
      expr: bookings_all_time - bookings_all_time_at_start_of_year
      metrics:
        - name: bookings_all_time
        - name: bookings_all_time
          offset_to_grain: year
          alias: bookings_all_time_at_start_of_year

  - name: bookings_month_start_compared_to_1_month_prior
    description: offset_to_grain + offset_window in same derived
    type: derived
    type_params:
      expr: month_start_bookings - bookings_1_month_ago
      metrics:
        - name: bookings
          offset_to_grain: month
          alias: month_start_bookings
        - name: bookings
          offset_window: 1 month
          alias: bookings_1_month_ago

  # --- Derived with fill_nulls ---
  - name: bookings_growth_2_weeks_fill_nulls_with_0
    description: offset derived filling 0 for both inputs
    type: derived
    type_params:
      expr: bookings_fill_nulls_with_0 - bookings_2_weeks_ago
      metrics:
        - name: bookings_fill_nulls_with_0
        - name: bookings_fill_nulls_with_0
          offset_window: 14 days
          alias: bookings_2_weeks_ago

  - name: bookings_growth_2_weeks_fill_nulls_with_0_for_non_offset
    description: offset derived filling 0 for one input only
    type: derived
    type_params:
      expr: bookings_fill_nulls_with_0 - bookings_2_weeks_ago
      metrics:
        - name: bookings_fill_nulls_with_0
        - name: bookings
          offset_window: 14 days
          alias: bookings_2_weeks_ago

  - name: twice_bookings_fill_nulls_with_0_without_time_spine
    description: 2x fill_nulls without time spine
    type: derived
    type_params:
      expr: 2 * bookings_fill_nulls_with_0_without_time_spine
      metrics:
        - name: bookings_fill_nulls_with_0_without_time_spine

  - name: nested_fill_nulls_without_time_spine
    description: 3x nested fill_nulls
    type: derived
    type_params:
      expr: 3 * twice_bookings_fill_nulls_with_0_without_time_spine
      metrics:
        - name: twice_bookings_fill_nulls_with_0_without_time_spine

  # --- Duplicate measure optimization ---
  - name: derived_bookings_0
    description: duplicate measure optimization test 0
    type: derived
    type_params:
      expr: bookings
      metrics:
        - name: bookings

  - name: derived_bookings_1
    description: duplicate measure optimization test 1
    type: derived
    type_params:
      expr: bookings
      metrics:
        - name: bookings

  # --- Shared alias edge cases ---
  - name: derived_shared_alias_1a
    description: same alias for different underlying metrics (a)
    type: derived
    type_params:
      expr: shared_alias - 10
      metrics:
        - name: bookings
          alias: shared_alias

  - name: derived_shared_alias_1b
    description: same alias for different underlying metrics (b)
    type: derived
    type_params:
      expr: shared_alias - 100
      metrics:
        - name: bookings
          alias: shared_alias

  - name: derived_shared_alias_2
    description: same alias name but different base metric
    type: derived
    type_params:
      expr: shared_alias + 10
      metrics:
        - name: instant_bookings
          alias: shared_alias

  - name: test_simple_derived_metric
    description: derived metric with 4 aliased inputs
    type: derived
    type_params:
      expr: alias_1 + alias_2 + alias_3 + alias_4
      metrics:
        - name: bookings
          alias: alias_1
        - name: referred_bookings
          alias: alias_2
        - name: instant_bookings
          alias: alias_3
        - name: booking_value
          alias: alias_4

  # --- Ratio metrics ---
  - name: bookings_per_booker
    description: bookings divided by bookers
    type: ratio
    type_params:
      numerator:
        name: bookings
      denominator:
        name: bookers

  - name: bookings_per_view
    description: bookings divided by views
    type: ratio
    type_params:
      numerator:
        name: bookings
      denominator:
        name: views

  - name: bookings_per_listing
    description: bookings divided by listings
    type: ratio
    type_params:
      numerator:
        name: bookings
      denominator:
        name: listings

  - name: bookings_per_dollar
    description: bookings per dollar of value
    type: ratio
    type_params:
      numerator:
        name: bookings
      denominator:
        name: booking_value

  - name: instant_booking_fraction_of_max_value
    description: constrained ratio with different filters on same measure
    type: ratio
    type_params:
      numerator:
        name: average_booking_value
        filter: "{{ Dimension('booking__is_instant') }}"
      denominator:
        name: max_booking_value

  - name: lux_booking_fraction_of_max_value
    description: constrained ratio with external dimension join
    type: ratio
    type_params:
      numerator:
        name: average_booking_value
        filter: "{{ Dimension('listing__is_lux_latest') }}"
      denominator:
        name: max_booking_value

  - name: instant_booking_value_ratio
    description: constrained ratio with alias and same base measure reuse
    type: ratio
    type_params:
      numerator:
        name: booking_value
        filter: "{{ Dimension('booking__is_instant') }}"
        alias: booking_value_with_is_instant_constraint
      denominator:
        name: booking_value

  - name: regional_starting_balance_ratios
    description: ratio of semi-additive measures with multiple categorical filters
    type: ratio
    type_params:
      numerator:
        name: total_account_balance_first_day
        filter: "{{ Dimension('user__home_state_latest') }} IN ('CA', 'HI', 'WA')"
        alias: west_coast_balance_first_day
      denominator:
        name: total_account_balance_first_day
        filter: "{{ Dimension('user__home_state_latest') }} IN ('MD', 'NY', 'TX')"
        alias: east_coast_balance_first_dat

  - name: popular_listing_bookings_per_booker
    description: ratio with metric filter and time_granularity
    type: ratio
    type_params:
      numerator:
        name: listings
      denominator:
        name: listings
    filter: "{{ Metric('views', ['listing']) }} > 10"
    time_granularity: week

  # --- Conversion metrics ---
  - name: visit_buy_conversion_rate_7days
    description: conversion rate 7-day window
    type: conversion
    type_params:
      conversion_type_params:
        base_measure: visits
        conversion_measure: buys
        window: 7 days
        entity: user
        calculation: conversion_rate

  - name: visit_buy_conversion_rate
    description: conversion rate no window
    type: conversion
    type_params:
      conversion_type_params:
        base_measure: visits
        conversion_measure: buys
        entity: user
        calculation: conversion_rate

  - name: visit_buy_conversions
    description: conversions count with fill_nulls_with
    type: conversion
    type_params:
      conversion_type_params:
        base_measure: visits
        conversion_measure:
          name: buys
          fill_nulls_with: 0
        window: 7 days
        entity: user
        calculation: conversions

  - name: visit_buy_conversion_rate_by_session
    description: conversion with constant_properties
    type: conversion
    type_params:
      conversion_type_params:
        base_measure: visits
        conversion_measure: buys
        window: 7 days
        entity: user
        calculation: conversion_rate
        constant_properties:
          - base_property: session
            conversion_property: session_id

  - name: visit_buy_conversion_rate_7days_fill_nulls_with_0
    description: conversion with fill_nulls_with and join_to_timespine on both
    type: conversion
    type_params:
      conversion_type_params:
        base_measure:
          name: visits
          fill_nulls_with: 0
          join_to_timespine: true
        conversion_measure:
          name: buys
          fill_nulls_with: 0
          join_to_timespine: true
        window: 7 days
        entity: user
        calculation: conversion_rate
